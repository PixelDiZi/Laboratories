

## Цель работы

Освоить методы интеграции KOMRAD SIEM с различными источниками данных (Nginx, Linux-системы, Windows-серверы) для централизованного сбора и обработки событий безопасности.

---

## Задачи работы

- Настроить передачу логов веб-сервера Nginx через протокол Syslog.
    
- Интегрировать Linux-систему с использованием rsyslog/TLS.
    
- Подключить Windows-сервер через WMI-агент KOMRAD.
    
- Проверить работоспособность подключений в веб-интерфейсе SIEM.
---

## Теоретическая часть  
### 1. Архитектура сбора данных в KOMRAD  
KOMRAD поддерживает три типа коллекторов:  
1. **Syslog-коллекторы** (RFC 5424): Для Linux-систем и сетевых устройств  
2. **WMI-агенты**: Для сбора событий Windows  
3. **Файловые агенты**: Для прямого чтения log-файлов  

### 2. Ключевые компоненты  
- **Сервер сбора**: Центральный узел KOMRAD (порты: UDP/514, TCP/10514)  
- **Конфигуратор источников**: Веб-интерфейс `https://<komrad-ip>:8000`  
- **Транспортные протоколы**:  
  - Linux: Rsyslog/TLS  
  - Windows: WMI через DCOM (порт 135)  
  - Nginx: Syslog over TCP  

---

## Ход выполнения  

### Часть 1: Подключение Nginx  
#### На сервере Nginx (Ubuntu):  
1. Установка rsyslog:  
```bash  
sudo apt install rsyslog  
```  

2. Конфигурация `/etc/nginx/nginx.conf`:  
```nginx  
access_log syslog:server=192.168.1.100:10514,tag=nginx;  
error_log syslog:server=192.168.1.100:10514,tag=nginx;  
```  

3. Перезагрузка сервисов:  
```bash  
sudo systemctl restart nginx rsyslog  
```  

#### В KOMRAD:  
1. **Управление коллекторами** → **Syslog** → **Добавить**:  
   - Порт: `10514`  
   - Протокол: `TCP`  
   - Теги: `nginx`  
   - Формат: `RFC 5424`  

---

### Часть 2: Подключение Linux-хоста  
#### На Linux-сервере (CentOS):  
1. Настройка `/etc/rsyslog.conf`:  
```  
*.* @@192.168.1.100:10514  
```  

2. Включение TLS (опционально):  
```bash  
sudo yum install rsyslog-gnutls  
echo 'DefaultNetstreamDriverCAFile="/etc/pki/tls/certs/ca-bundle.crt"' >> /etc/rsyslog.conf  
```  

3. Перезапуск:  
```bash  
sudo systemctl restart rsyslog  
```  

#### В KOMRAD:  
1. **Управление коллекторами** → **Syslog** → **Добавить**:  
   - Порт: `10514`  
   - Протокол: `TCP`  
   - Теги: `linux_syslog`  

---

### Часть 3: Подключение Windows через WMI Agent  
#### На Windows-сервере:  
1. Скачать агент:  
   - `https://repo.komrad-si.ru/windows/KOMRAD-Agent-Windows-x64.msi`  

2. Установить с параметрами:  
```powershell  
msiexec /i KOMRAD-Agent-Windows-x64.msi SERVER="192.168.1.100" PORT=5985  
```  

3. Проверить службу:  
```powershell  
Get-Service -Name "KOMRAD-WMI-Agent"  
```  

#### В KOMRAD:  
1. **Управление коллекторами** → **WMI** → **Добавить узел**:  
   - IP: `<windows-ip>`  
   - Учетные данные: `DOMAIN\AdminUser`  
   - Источники событий:  
     - `Security` (ID 4624/4625)  
     - `System`  
     - `Application`  

---

## Проверка подключения  
### Для всех источников:  
1. В **Администрирование** → **Статус коллекторов**:  
   - Проверить статус `Активен`  
   - Убедиться в наличии входящих событий  

2. В **Мониторинг** → **Журнал событий**:  
   - Фильтр: `Источник: ("nginx", "linux_syslog", "wmi")`  
   - Убедиться в получении событий  

---

## Форма отчёта  
1. **Скриншоты конфигураций**:  
   - Фрагмент nginx.conf  
   - Настройки rsyslog на Linux  
   - Окно установки WMI-агента  
2. **Скриншоты KOMRAD**:  
   - Список активных коллекторов  
   - Статус источников в мониторинге  
3. **Таблица параметров**:  

| Источник  | Порт  | Протокол | Тег/Идентификатор |  
|-----------|-------|----------|-------------------|  
| Nginx     | 10514 | TCP      | nginx             |  
| Linux     | 10514 | TCP      | linux_syslog      |  
| Windows   | 5985  | WMI      | windows_events    |  

---

## Вопросы для самоконтроля  
1. Почему для Nginx предпочтительнее TCP вместо UDP?  
2. Как обеспечить целостность данных при передаче из Linux?  
3. Какие порты необходимо открыть на фаерволе для WMI?  
4. Как верифицировать успешность отправки данных с Nginx?  
5. Где хранятся конфигурации коллекторов в KOMRAD?  

> **Требования безопасности**:  
> - Для WMI использовать отдельную доменную учетную запись с минимальными привилегиями  
> - Настроить TLS для Syslog-соединений  
> - Ограничить доступ к портам коллектора по IP  

---

## Приложения  
### Команды диагностики:  
1. Проверка открытых портов KOMRAD:  
```bash  
sudo netstat -tulpn | grep 10514  
```  

2. Мониторинг событий в реальном времени:  
```bash  
tail -f /var/log/komrad/collectors/syslog.log  
```  

### Ссылки на документацию:  
- [Руководство по интеграции Nginx](https://docs.komrad-si.ru/v22.1/integrations/nginx/)  
- [Настройка WMI-агента](https://docs.komrad-si.ru/v22.1/agents/wmi-windows/)  
- [Типовые конфигурации rsyslog](https://docs.komrad-si.ru/v22.1/collectors/syslog/linux/)  

> **Важно**: Для промышленной эксплуатации настроить ротацию логов коллектора (`/var/log/komrad/`) через logrotate.